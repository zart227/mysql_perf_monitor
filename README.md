# MySQL Performance Monitor

Система мониторинга производительности MySQL через SSH с фокусом на сбор метрик CPU и памяти, а также генерацию отчетов в Markdown.

## Возможности

- Подключение к удаленному серверу по SSH
- Сбор базовых метрик (cpuinfo, глобальные переменные MySQL)
- Непрерывный мониторинг нагрузки CPU процесса mysqld
- Логирование пиков CPU и высокого потребления памяти
- Автоматическое переподключение при разрыве SSH-соединения
- Генерация отчетов в формате Markdown с красивыми таблицами
- Отслеживание топ-5 самых долгих запросов MySQL в момент пика CPU

## Установка

Для быстрой настройки окружения и установки зависимостей, выполните скрипт `setup.sh`:

```bash
./setup.sh
```

Этот скрипт автоматически:
- Обновит `pip`.
- Создаст виртуальное окружение `venv`.
- Установит все необходимые пакеты из `requirements.txt`.

После выполнения скрипта, не забудьте настроить конфигурацию:

1.  Создайте файл `.env` на основе `.env.example`:
    ```bash
    cp .env.example .env
    ```
2.  Настройте переменные окружения в файле `.env` и, при необходимости, параметры в `config/config.py`.

Для активации виртуального окружения вручную используйте:
```bash
source venv/bin/activate  # Для Linux/Mac
```
Или для Windows:
```bash
venv\Scripts\activate
```

## Настройки

Основные настройки находятся в файле `config/config.py` и `.env`:

### Переменные окружения (.env)
Создайте файл `.env` в корне проекта для хранения конфиденциальных данных:

```bash
# SSH настройки
SSH_HOST=your_ssh_host
SSH_PORT=22
SSH_USER=your_ssh_user
SSH_PASSWORD=your_ssh_password

# MySQL настройки
MYSQL_USER=your_mysql_user
MYSQL_PASSWORD=your_mysql_password
MYSQL_HOST=your_mysql_host
MYSQL_PORT=3306

# Настройки мониторинга
DEBUG_MODE=False
HIGH_FREQ_CPU_THRESHOLD=80.0
HIGH_FREQ_MEMORY_THRESHOLD=90.0
HIGH_FREQ_MONITORING_INTERVAL=10
CONTINUOUS_MONITOR_INTERVAL_SECONDS=10

# Настройки логирования
LOG_TO_FILE=True          # Записывать логи в файл
LOG_TO_CONSOLE=True       # Выводить логи в консоль
LOG_LEVEL=INFO           # Уровень логирования: DEBUG, INFO, WARNING, ERROR, CRITICAL

# Email-отчеты
EMAIL_REPORT_TIMES=09:00,23:59
```

**Важно**: Файл `.env` не должен попадать в систему контроля версий. Убедитесь, что он добавлен в `.gitignore`.

### Дополнительные настройки
Для более детальной настройки отредактируйте файл `config/config.py`.

### Управление логированием
Система поддерживает гибкое управление логированием:

- **LOG_TO_FILE** - записывать логи в файл (по умолчанию: True)
- **LOG_TO_CONSOLE** - выводить логи в консоль (по умолчанию: True)
- **LOG_LEVEL** - уровень логирования (по умолчанию: INFO)

Примеры настроек:
```bash
# Только файл, без вывода в консоль
LOG_TO_FILE=True
LOG_TO_CONSOLE=False

# Только консоль, без записи в файл
LOG_TO_FILE=False
LOG_TO_CONSOLE=True

# Только ошибки в консоль
LOG_TO_FILE=True
LOG_TO_CONSOLE=True
LOG_LEVEL=ERROR
```

## Использование

1. Активируйте виртуальное окружение:
   ```bash
   source venv/bin/activate  # Linux/Mac
   # или
   venv\Scripts\activate     # Windows
   ```

2. Запустите мониторинг:
   ```bash
   python3 main.py
   ```

## Структура проекта

```
mysql_perf_monitor/
├── config/           # Конфигурация
├── core/            # Основная логика
├── report/          # Генерация отчетов
├── logs/            # Логи мониторинга
├── reports/         # Сгенерированные отчеты
└── main.py          # Точка входа
```

## Отчеты

Система генерирует два типа отчетов:

1. **Базовый отчет** (`baseline_report.md`) - создается один раз при запуске
2. **Отчет о событиях** (`events_report_YYYYMMDD.md`) - обновляется при обнаружении пиков CPU

Отчеты включают:
- Информацию о системе
- Метрики производительности
- Таблицы с активными запросами MySQL
- Рекомендации по оптимизации

## Логирование

Логи сохраняются в директории `logs/` с именем файла `mysql_perf_reporter_YYYYMMDD.log`.

## Архивация и ротация

Система автоматически управляет накоплением отчетов и логов:

### Как работает архивация

- **Неархивированные файлы** хранятся **7 дней** (настраивается через `ARCHIVE_DAYS_TO_KEEP_UNARCHIVED`)
- **Архивы** хранятся **3 месяца** (настраивается через `ARCHIVE_DAYS_TO_KEEP_ARCHIVED`)
- Файлы старше 7 дней автоматически группируются по месяцам и упаковываются в `.tar.gz` архивы
- Архивы сохраняются в подпапках:
  - `reports/archive/` — для отчетов
  - `logs/archive/` — для логов
- Архивы старше 3 месяцев автоматически удаляются

### Настройка архивации

Добавьте в файл `.env`:

```bash
# Архивация
ARCHIVE_ENABLED=True                      # Включить/выключить автоматическую архивацию
ARCHIVE_DAYS_TO_KEEP_UNARCHIVED=7       # Дней хранения неархивированных файлов
ARCHIVE_DAYS_TO_KEEP_ARCHIVED=90        # Дней хранения архивов (3 месяца)
ARCHIVE_DAILY_TIME=03:00                 # Время ежедневной проверки и архивации
```

### Когда происходит архивация

1. **При запуске приложения** — автоматически выполняется проверка и архивация старых файлов
2. **Ежедневно в указанное время** — по расписанию (по умолчанию в 03:00)
3. **Вручную** — можно запустить в любой момент:

```bash
# Запуск архивации вручную
python tools/run_archive.py

# Или через модуль
python -m tools.run_archive
```

### Пример структуры архивов

```
reports/
├── daily_summary_20251018.md
├── daily_summary_20251019.md
├── daily_summary_20251020.md
├── daily_summary_20251021.md
├── events_report_20251018.md
├── events_report_20251019.md
├── events_report_20251020.md
├── events_report_20251021.md
└── archive/
    ├── reports_2025_06.tar.gz    # Архив за июнь 2025
    ├── reports_2025_07.tar.gz    # Архив за июль 2025
    └── reports_2025_08.tar.gz    # Архив за август 2025

logs/
├── mysql_perf_reporter.log
├── mysql_perf_reporter.log.20251019
├── mysql_perf_reporter.log.20251020
├── mysql_perf_reporter.log.20251021
└── archive/
    ├── logs_2025_06.tar.gz
    ├── logs_2025_07.tar.gz
    └── logs_2025_08.tar.gz
```

### Отключение архивации

Если архивация не нужна, установите в `.env`:

```bash
ARCHIVE_ENABLED=False
```

### Восстановление файлов из архива

Если вам нужно восстановить файлы из архива:

```bash
# Просмотр содержимого архива
tar -tzf reports/archive/reports_2025_06.tar.gz

# Извлечение всех файлов
tar -xzf reports/archive/reports_2025_06.tar.gz -C reports/

# Извлечение конкретного файла
tar -xzf reports/archive/reports_2025_06.tar.gz events_report_20250623.md -C reports/
```

## Завершение работы

Для корректного завершения используйте `Ctrl+C`. Система автоматически закроет SSH-соединение и сохранит все данные.

## Описание
Автоматизированный инструмент для сбора, анализа и формирования отчётов по производительности MySQL и системы через SSH. Работает по расписанию, выявляет критические показатели и формирует рекомендации.

## Требования
- Python 3.10+
- Linux/Windows
- pip install -r requirements.txt

## Настройка
1. Отредактируйте файл `config/config.py` для указания SSH и MySQL параметров.
2. Укажите временные окна мониторинга и список команд.

## Запуск
```bash
python -m mysql_perf_reporter.main
```

## Пример отчёта
См. `examples/report_example.md`

## Структура проекта
- config/ — конфиги и параметры
- core/ — логика сбора, анализа, логирования
- report/ — генерация отчётов
- logs/ — логи
- examples/ — примеры отчётов

## Контакты
Автор: <ваше имя>

## Email-отчеты

Время отправки email-отчетов настраивается через переменную EMAIL_REPORT_TIMES в `.env`:

```env
EMAIL_REPORT_TIMES=09:00,23:59
```
- Можно указать несколько значений через запятую (например, `08:00,12:00,18:00`).
- Формат времени — HH:MM (24-часовой).
- По умолчанию письма отправляются в 09:00 и 23:59.

**Все параметры SMTP/email также настраиваются через .env:**
- EMAIL_ENABLED, SMTP_SERVER, SMTP_PORT, SMTP_USER, SMTP_PASSWORD, FROM_ADDR, TO_ADDRS

## Запуск через Docker

> **Контейнер автоматически использует московское время (Europe/Moscow).**

1. Убедитесь, что у вас есть файл `.env` с нужными переменными (или скопируйте и заполните `.env.example`).
2. Соберите и запустите контейнер:
   ```bash
   docker compose up --build -d
   ```
3. Для просмотра логов:
   ```bash
   docker logs -f mysql_perf_monitor
   ```
4. Для остановки:
   ```bash
   docker compose down
   ```

**Логи и отчеты будут сохраняться в папках `logs/` и `reports/` на вашей машине.** 