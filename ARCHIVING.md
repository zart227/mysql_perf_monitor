# Система архивации отчетов и логов

## Обзор

Система автоматически управляет хранением отчетов и логов для экономии дискового пространства.

## Как это работает

### Правила хранения

- **Неархивированные файлы**: хранятся **7 дней**
- **Архивы**: хранятся **3 месяца** (90 дней)
- Файлы группируются по месяцам в `.tar.gz` архивы
- Старые архивы автоматически удаляются

### Что архивируется

1. **Отчеты** (`reports/`):
   - `events_report_YYYYMMDD.md`
   - `daily_summary_YYYYMMDD.md`
   - Исключение: `baseline_report.md` никогда не архивируется

2. **Логи** (`logs/`):
   - `mysql_perf_reporter.log.YYYYMMDD`
   - `mysql_perf_reporter_YYYYMMDD.log`
   - Исключение: текущий активный лог `mysql_perf_reporter.log`

3. **CPU Events** (`reports/events/cpu/`):
   - `YYYY-MM-DD.csv` — события по загрузке CPU
   
4. **Memory Events** (`reports/events/memory/`):
   - `YYYY-MM-DD.csv` — события по использованию памяти

### Структура архивов

```
reports/
├── archive/
│   ├── reports_2025_06.tar.gz
│   ├── reports_2025_07.tar.gz
│   └── reports_2025_08.tar.gz
├── events/
│   ├── cpu/
│   │   ├── archive/
│   │   │   ├── cpu_2025_06.tar.gz
│   │   │   └── cpu_2025_07.tar.gz
│   │   └── [текущие файлы за последние 7 дней]
│   └── memory/
│       ├── archive/
│       │   ├── memory_2025_06.tar.gz
│       │   ├── memory_2025_07.tar.gz
│       │   └── memory_2025_08.tar.gz
│       └── [текущие файлы за последние 7 дней]
└── [текущие файлы за последние 7 дней]

logs/
├── archive/
│   ├── logs_2025_06.tar.gz
│   ├── logs_2025_07.tar.gz
│   └── logs_2025_08.tar.gz
└── [текущие файлы за последние 7 дней]
```

## Настройка

### Переменные окружения (.env)

```bash
# Включить/выключить архивацию
ARCHIVE_ENABLED=True

# Дней хранения неархивированных файлов
ARCHIVE_DAYS_TO_KEEP_UNARCHIVED=7

# Дней хранения архивов (3 месяца = 90 дней)
ARCHIVE_DAYS_TO_KEEP_ARCHIVED=90

# Время ежедневной проверки и архивации
ARCHIVE_DAILY_TIME=03:00
```

## Когда запускается архивация

1. **При старте приложения** — автоматически
2. **Ежедневно в 03:00** — по расписанию
3. **Вручную** — можно запустить в любой момент

## Ручной запуск

### Запуск архивации

```bash
# Активируйте виртуальное окружение
source venv/bin/activate

# Запустите скрипт архивации
python tools/run_archive.py
```

или

```bash
python -m tools.run_archive
```

### Просмотр содержимого архива

```bash
# Список файлов в архиве
tar -tzf reports/archive/reports_2025_06.tar.gz

# Список с подробностями
tar -tzvf reports/archive/reports_2025_06.tar.gz
```

### Восстановление файлов

```bash
# Восстановить все файлы из архива
tar -xzf reports/archive/reports_2025_06.tar.gz -C reports/

# Восстановить конкретный файл
tar -xzf reports/archive/reports_2025_06.tar.gz events_report_20250623.md -C reports/

# Просто посмотреть содержимое без извлечения
tar -xzf reports/archive/reports_2025_06.tar.gz events_report_20250623.md -O | less
```

## Отключение архивации

Если автоматическая архивация не нужна:

1. Отредактируйте `.env`:
   ```bash
   ARCHIVE_ENABLED=False
   ```

2. Перезапустите приложение

## Логи архивации

Все операции архивации логируются в основной лог-файл `logs/mysql_perf_reporter.log`:

```
2025-10-21 12:07:44 [INFO] Запуск процесса архивации и очистки
2025-10-21 12:07:44 [INFO] Создан архив: reports/archive/reports_2025_09.tar.gz (60 файлов)
2025-10-21 12:07:44 [INFO] Всего заархивировано и удалено файлов из reports/: 202
2025-10-21 12:07:44 [INFO] Процесс архивации и очистки завершен успешно
```

## Размер архивов

Архивы сжимаются с использованием gzip, что обеспечивает хорошую степень сжатия:

- Отчеты (markdown): обычно сжимаются в 10-20 раз
- Логи: обычно сжимаются в 5-10 раз
- Events (CSV): обычно сжимаются в 15-30 раз

Примеры реальных архивов:

**Отчеты:**
```
reports_2025_06.tar.gz - 233K (13 файлов)
reports_2025_07.tar.gz - 29K  (42 файла)
reports_2025_08.tar.gz - 3.6K (60 файлов)
```

**Логи:**
```
logs_2025_06.tar.gz - 8.8K  (3 файла)
logs_2025_07.tar.gz - 1.1M  (31 файл)
logs_2025_08.tar.gz - 1.1M  (31 файл)
```

**Events:**
```
cpu_2025_06.tar.gz    - 35K  (5 файлов)
memory_2025_07.tar.gz - 1.2K (21 файл)
memory_2025_08.tar.gz - 1.6K (30 файлов)
```

**Общий размер всех архивов:** ~4.1 MB (сжато)

## Безопасность

- Архивы создаются в режиме `append`, что позволяет дополнять существующие архивы
- Файлы удаляются только после успешного добавления в архив
- При ошибках архивации оригинальные файлы сохраняются
- Все операции логируются для аудита

## Техническая информация

- **Модуль**: `tools/archive_manager.py`
- **Скрипт**: `tools/run_archive.py`
- **Конфигурация**: `config/config.py`
- **Формат архивов**: `.tar.gz` (tar + gzip)
- **Группировка**: по месяцам (год_месяц)

